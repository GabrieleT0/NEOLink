SSLUseStapling on
SSLStaplingResponderTimeout 5
SSLStaplingReturnResponderErrors off
SSLStaplingCache shmcb:/var/run/ocsp(128000)

<VirtualHost *:80>
   ServerName "neolink.neolaiacampus.eu"
   Redirect permanent "/" "https://neolink.neolaiacampus.eu/"
</VirtualHost>

<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerName neolink.neolaiacampus.eu:443
        ServerAdmin gtuozzo@unisa.it

        DocumentRoot /var/www/html/neolink.neolaiacampus.eu

        # Logging
        CustomLog /var/log/apache2/neolink.neolaiacampus.eu.log combined
        ErrorLog /var/log/apache2/neolink.neolaiacampus.eu-error.log

        # SSL Configuration
        SSLEngine On
        SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS"
        SSLHonorCipherOrder on

        SSLCertificateFile /etc/letsencrypt/live/neolink.neolaiacampus.eu/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/neolink.neolaiacampus.eu/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf

        # Security Headers
        <IfModule headers_module>
            Header set X-Frame-Options DENY
            Header always set Strict-Transport-Security "max-age=63072000;includeSubDomains;preload"
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-XSS-Protection "1; mode=block"
            Header always set Referrer-Policy "strict-origin-when-cross-origin"
        </IfModule>

        # Shibboleth

        # Redirect needed to retrieve SP Metadata from its entityID
        Redirect "/shibboleth" "/Shibboleth.sso/Metadata"

        # Shibboleth Handler
        <Location /Shibboleth.sso>
            SetHandler shib
        </Location>

        # Shibboleth Protected Authentication Endpoint
        # Requires active Shibboleth session — forces login if not authenticated.
        # Passes user attributes as headers to the Strapi backend.
        <Location /api/auth/shibboleth>
            AuthType shibboleth
            ShibRequestSetting requireSession 1
            Require shib-session

            # Pass Shibboleth attributes as headers to Strapi
            # These headers must match IDEM/eduGAIN attribute release
            RequestHeader set X-Shib-cn "%{cn}e" env=cn
            RequestHeader set X-Shib-Mail "%{mail}e" env=mail
            RequestHeader set X-Shib-DisplayName "%{displayName}e" env=displayName
            RequestHeader set X-Shib-GivenName "%{givenName}e" env=givenName
            RequestHeader set X-Shib-Affiliation "%{affiliation}e" env=affiliation
            RequestHeader set X-Shib-PairwiseId "%{pairwise-id}e" env=pairwise-id
            RequestHeader set X-Shib-EduPersonId "%{edu-person-id}e" env=edu-person-id
            RequestHeader set X-Shib-PersistentId "%{persistent-id}e" env=persistent-id
            RequestHeader set X-Shib-EduPersonAffiliation "%{eduPersonAffiliation}e" env=eduPersonAffiliation
            RequestHeader set X-Shib-Session-ID "%{Shib-Session-ID}e" env=Shib-Session-ID

            ProxyPass http://localhost:1337/api/auth/shibboleth
            ProxyPassReverse http://localhost:1337/api/auth/shibboleth
        </Location>

        # Shibboleth Session Check (lazy session — does NOT force login)
        # Used by the frontend to check if a Shibboleth session already exists.
        <Location /api/auth/shibboleth/session>
            AuthType shibboleth
            ShibRequestSetting requireSession 0
            Require shibboleth

            RequestHeader set X-Shib-EPPN "%{eppn}e" env=eppn
            RequestHeader set X-Shib-Mail "%{mail}e" env=mail
            RequestHeader set X-Shib-DisplayName "%{displayName}e" env=displayName
            RequestHeader set X-Shib-Session-ID "%{Shib-Session-ID}e" env=Shib-Session-ID

            ProxyPass http://localhost:1337/api/auth/shibboleth/session
            ProxyPassReverse http://localhost:1337/api/auth/shibboleth/session
        </Location>

        # Shibboleth Logout Endpoint
        <Location /api/auth/shibboleth/logout>
            AuthType shibboleth
            ShibRequestSetting requireSession 0
            Require shibboleth

            ProxyPass http://localhost:1337/api/auth/shibboleth/logout
            ProxyPassReverse http://localhost:1337/api/auth/shibboleth/logout
        </Location>

        # Proxy Settings
        
        ProxyPreserveHost On
        ProxyRequests Off

        # WebSocket support (required for Strapi admin)
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) ws://localhost:1337/$1 [P,L]

        # Strapi admin static files
        ProxyPass /admin/_next http://localhost:1337/admin/_next
        ProxyPassReverse /admin/_next http://localhost:1337/admin/_next

        # Strapi admin
        ProxyPass /admin http://localhost:1337/admin
        ProxyPassReverse /admin http://localhost:1337/admin

        # Strapi API routes (generic — Shibboleth-specific <Location> blocks above take priority)
        ProxyPass /api http://localhost:1337/api
        ProxyPassReverse /api http://localhost:1337/api

        # Strapi uploads
        ProxyPass /uploads http://localhost:1337/uploads
        ProxyPassReverse /uploads http://localhost:1337/uploads

        # Strapi content-manager & content-type-builder (admin API)
        ProxyPass /content-manager http://localhost:1337/content-manager
        ProxyPassReverse /content-manager http://localhost:1337/content-manager

        ProxyPass /content-type-builder http://localhost:1337/content-type-builder
        ProxyPassReverse /content-type-builder http://localhost:1337/content-type-builder

        # Strapi i18n
        ProxyPass /i18n http://localhost:1337/i18n
        ProxyPassReverse /i18n http://localhost:1337/i18n

        # Shibboleth.sso must NOT be proxied — handled by mod_shib
        ProxyPass /Shibboleth.sso !
        ProxyPass /shibboleth !

        # Frontend → Next.js/React (localhost:3000) — must be LAST
        ProxyPass / http://localhost:3000/
        ProxyPassReverse / http://localhost:3000/

    </VirtualHost>
</IfModule>